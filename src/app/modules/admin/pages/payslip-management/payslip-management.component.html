<div class="p-6 pt-0">
    
  <p-toast position="top-center"></p-toast> 

  <p-card header="Generación de Boletas de Pago" styleClass="shadow-lg mb-8">
      <form (ngSubmit)="generatePayslip()" class="space-y-6">
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              
              <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Empleado:</label>
                  <p-dropdown 
                      [options]="(employees$ | async) ?? []" 
                      [(ngModel)]="generationForm.employeeId" 
                      optionLabel="fullName" 
                      optionValue="id" 
                      placeholder="-- Trabajador --" 
                      name="employeeId" 
                      required
                      styleClass="w-full">
                       <ng-template let-emp pTemplate="item">
                          <div>{{ emp.fullName }} ({{ emp.employeeCode }})</div>
                      </ng-template>
                  </p-dropdown>
              </div>

              <div>
                
                  <label class="block text-sm font-medium text-gray-700 mb-1">Inicio Período:</label>
                  <input type="date" [(ngModel)]="generationForm.startDate" name="startDate" required
                         class="w-full p-2 border rounded-md">
              </div>

              <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Fin del Período:</label>
                  <input type="date" [(ngModel)]="generationForm.endDate" name="endDate" required
                         class="w-full p-2 border rounded-md">
              </div>
          </div>

          <div class="pt-2">
              <p-button 
                  label="{{ isLoading ? 'Calculando y Generando...' : 'Generar Boleta y PDF' }}" 
                  icon="pi pi-calculator" 
                  [loading]="isLoading" 
                  type="submit"
                  [disabled]="!generationForm.employeeId || !generationForm.startDate || !generationForm.endDate || isLoading"
                  styleClass="p-button-success w-full shadow-md">
              </p-button>
          </div>
      </form>
  </p-card>

  <div class="mt-8">
      <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Historial de Boletas Generadas</h2>
      
      <p-button icon="pi pi-refresh" label="Actualizar Historial" (onClick)="loadGeneratedPayslips()" styleClass="p-button-sm p-button-outlined mb-4"></p-button>

      <p-table [value]="generatedPayslips" 
               [paginator]="true" 
               [rows]="5" 
               [loading]="isLoadingList"
               styleClass="p-datatable-gridlines p-datatable-striped shadow-md">
        
        <ng-template pTemplate="header">
          <tr>
            <th>ID Boleta</th>
            <th>Cód. Empleado</th>
            <th>Período de Pago</th>
            <th>Salario Neto Calculado</th>
            <th class="w-20 text-center">Acción</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-payslip>
          <tr>
            <td>{{ payslip.id }}</td>
            <td>{{ payslip.employee?.employeeCode || 'N/A' }}</td>
            <td>{{ payslip.payPeriodStart | date:'mediumDate' }} - {{ payslip.payPeriodEnd | date:'mediumDate' }}</td>
            <td class="font-bold text-green-700">{{ payslip.netSalary | currency:'PEN':'symbol':'1.2-2' }}</td>
            <td class="text-center">
              <p-button icon="pi pi-download" styleClass="p-button-sm p-button-success" 
                        (onClick)="downloadPayslip(payslip.id, getFileNameForPayslip(payslip))" pTooltip="Descargar PDF">
              </p-button>
            </td>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="emptymessage">
          <tr><td colspan="5" class="text-center py-4 text-gray-500">No se han generado boletas.</td></tr>
        </ng-template>
      </p-table>
  </div>
</div>
