<p-toast></p-toast>

<div class="p-6 md:p-10 pt-4 bg-gray-50 min-h-screen">
  <div class="bg-white p-6 rounded-xl shadow-lg border">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6">Control de Asistencia Diario</h1>

    <p-table #dt [value]="employeeStatuses" [paginator]="true" [rows]="10" [loading]="isLoading"
      styleClass="p-datatable-gridlines p-datatable-striped" responsiveLayout="scroll"
      [globalFilterFields]="['fullName', 'position', 'employeeCode']">

      <ng-template pTemplate="caption">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
          <div class="flex items-center gap-2">
            <p-calendar [(ngModel)]="selectedDate" (onSelect)="loadDailyStatus()" dateFormat="dd/mm/yy"
              [showIcon]="true" inputId="date-selector"></p-calendar>
            <p-button icon="pi pi-refresh" (onClick)="loadDailyStatus()" pTooltip="Actualizar"
              styleClass="p-button-secondary"></p-button>
          </div>

          <p-iconField iconPosition="left">
            <p-inputIcon styleClass="pi pi-search" />
            <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar en la tabla..."
              class="w-full md:w-auto" />
          </p-iconField>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="employeeCode">Código <p-sortIcon field="employeeCode"></p-sortIcon></th>
          <th pSortableColumn="fullName">Trabajador <p-sortIcon field="fullName"></p-sortIcon></th>
          <th pSortableColumn="position">Cargo <p-sortIcon field="position"></p-sortIcon></th>
          <th>Último Marcaje</th>
          <th pSortableColumn="status">Estado Hoy <p-sortIcon field="status"></p-sortIcon></th>
          <th class="text-center">Acción Manual</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-status>
        <tr>
          <td>{{ status.employeeCode }}</td>
          <td>{{ status.fullName }}</td>
          <td>{{ status.position }}</td>
          <td>
            <span *ngIf="status.lastMarkTime; else noMark">{{ status.lastMarkTime }} ({{ status.reportDate | date:'shortDate' }})</span>
            <ng-template #noMark>--</ng-template>
          </td>
          <td>
            <p-tag [value]="status.status | titlecase"
              [severity]="status.status === 'ASISTIO' ? 'success' : (status.status === 'NO_REGISTRADO' ? 'danger' : 'info')">
            </p-tag>
          </td>
          <td class="text-center">
            <p-button [label]="getButtonText(status.status)"
              [icon]="status.status === 'ASISTIO' ? 'pi pi-sign-out' : 'pi pi-sign-in'"
              [pTooltip]="getButtonText(status.status)"
              [disabled]="status.status === 'SALIO'"
              [styleClass]="status.status === 'ASISTIO' ? 'p-button-sm p-button-warning' : 'p-button-sm p-button-success'"
              (click)="registerManualMark(status)"></p-button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center py-10">
            <i class="pi pi-calendar-times text-4xl text-gray-400 mb-3"></i>
            <p class="text-lg text-gray-600">No hay datos de asistencia para esta fecha.</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
