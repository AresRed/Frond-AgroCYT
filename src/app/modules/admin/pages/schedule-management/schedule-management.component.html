<p-toast></p-toast>

<div class="p-6 md:p-10 pt-4 bg-gray-50 min-h-screen">
  <h1 class="text-3xl font-extrabold text-gray-800 mb-6">Gestión de Horarios y Turnos</h1>

  <!-- 1. Tabla de Plantillas Existentes -->
  <p-panel header="Plantillas de Turno Existentes" class="mb-8">
    <p-table [value]="(schedules$ | async) ?? []" [paginator]="true" [rows]="5"
      styleClass="p-datatable-gridlines p-datatable-striped" responsiveLayout="scroll">
      <ng-template pTemplate="header">
        <tr>
          <th class="px-4 py-2">Nombre del Turno</th>
          <th class="px-4 py-2">Hora Entrada</th>
          <th class="px-4 py-2">Hora Salida</th>
          <th class="px-4 py-2">Tolerancia (min)</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-schedule>
        <tr>
          <td class="px-4 py-2">{{ schedule.name }}</td>
          <td class="px-4 py-2">{{ schedule.startTime }}</td>
          <td class="px-4 py-2">{{ schedule.endTime }}</td>
          <td class="px-4 py-2">{{ schedule.toleranceMinutes }}</td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="4" class="text-center py-4">No hay plantillas de turno creadas.</td>
        </tr>
      </ng-template>
    </p-table>
  </p-panel>

  <!-- 2. Formularios en un Acordeón -->
  <p-accordion>
    <!-- Panel para Crear Plantilla de Turno -->
    <p-accordionTab header="Crear Nueva Plantilla de Turno">
      <form (ngSubmit)="createSchedule()" class="space-y-6 p-4">
        <p-floatLabel>
          <input pInputText id="name" [(ngModel)]="newSchedule.name" name="name" required class="w-full" />
          <label for="name">Nombre del Turno (Ej: Mañana Uva)</label>
        </p-floatLabel>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <p-floatLabel>
            <p-calendar [(ngModel)]="newSchedule.startTime" name="startTime" [timeOnly]="true" hourFormat="24"
              inputId="startTime" required styleClass="w-full"></p-calendar>
            <label for="startTime">Hora Entrada</label>
          </p-floatLabel>
          <p-floatLabel>
            <p-calendar [(ngModel)]="newSchedule.endTime" name="endTime" [timeOnly]="true" hourFormat="24"
              inputId="endTime" required styleClass="w-full"></p-calendar>
            <label for="endTime">Hora Salida</label>
          </p-floatLabel>
        </div>

        <p-floatLabel>
          <p-inputNumber [(ngModel)]="newSchedule.toleranceMinutes" name="toleranceMinutes" inputId="tolerance"
            required [min]="0" [max]="60" suffix=" minutos"></p-inputNumber>
          <label for="tolerance">Tolerancia (minutos)</label>
        </p-floatLabel>

        <p-button type="submit" [label]="isLoading ? 'Guardando...' : 'Guardar Plantilla'" icon="pi pi-save"
          [loading]="isLoading" styleClass="p-button-secondary w-full"></p-button>
      </form>
    </p-accordionTab>

    <!-- Panel para Asignar Horario -->
    <p-accordionTab header="Asignar Horario a Empleado">
      <form (ngSubmit)="assignSchedule()" class="space-y-6 p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <p-floatLabel>
            <p-dropdown [options]="(employees$ | async) ?? []" [(ngModel)]="assignmentForm.employeeId" name="employeeId"
              required optionLabel="fullName" optionValue="id"  [filter]="true"
              styleClass="w-full"></p-dropdown>
            <label>Empleado</label>
          </p-floatLabel>

          <p-floatLabel>
            <p-dropdown [options]="(schedules$ | async) ?? []" [(ngModel)]="assignmentForm.scheduleId"
              name="scheduleId" required optionLabel="name" optionValue="id" 
              styleClass="w-full"></p-dropdown>
            <label>Turno (Plantilla)</label>
          </p-floatLabel>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <p-floatLabel>
            <p-calendar [(ngModel)]="assignmentForm.validFrom" name="validFrom" dateFormat="yy-mm-dd"
              inputId="validFrom" required></p-calendar>
            <label for="validFrom">Válido Desde</label>
          </p-floatLabel>
          <p-floatLabel>
            <p-calendar [(ngModel)]="assignmentForm.validTo" name="validTo" dateFormat="yy-mm-dd"
              inputId="validTo"></p-calendar>
            <label for="validTo">Válido Hasta (Opcional)</label>
          </p-floatLabel>
        </div>

        <div>
          <label class="text-sm font-semibold text-gray-600 block mb-2">Días Laborables:</label>
          <div class="flex flex-wrap gap-2">
            <p-button *ngFor="let day of weekDays" type="button" [label]="day.name" (onClick)="toggleDay(day)"
              [styleClass]="day.selected ? 'p-button-sm p-button-success' : 'p-button-sm p-button-outlined p-button-secondary'">
            </p-button>
          </div>
        </div>

        <p-button type="submit" [label]="isLoading ? 'Asignando...' : 'Asignar Horario'" icon="pi pi-check"
          [loading]="isLoading" styleClass="p-button-success w-full"></p-button>
      </form>
    </p-accordionTab>
  </p-accordion>
</div>
