<p-toast></p-toast>

<div class="p-6 md:p-10 pt-4 bg-gray-50 min-h-screen">
  <p-panel [header]="headerTitle">
    <form [formGroup]="employeeForm" (ngSubmit)="onSubmit()" class="p-4">

      <!-- Sección de Datos Personales -->
      <h3 class="text-lg font-semibold text-gray-700 mb-4">Datos Personales</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <p-floatLabel>
            <p-inputMask id="dni" formControlName="dni" mask="99999999" styleClass="w-full" />
            <label for="dni">DNI (8 dígitos)</label>
          </p-floatLabel>
          <small *ngIf="employeeForm.get('dni')?.invalid && employeeForm.get('dni')?.touched" class="p-error">
            El DNI es requerido y debe tener 8 dígitos.
          </small>
        </div>
        <div>
          <p-floatLabel>
            <input pInputText id="employeeCode" formControlName="employeeCode" class="w-full" />
            <label for="employeeCode">Código Único (Ej: AGR005)</label>
          </p-floatLabel>
          <small *ngIf="employeeForm.get('employeeCode')?.invalid && employeeForm.get('employeeCode')?.touched" class="p-error">
            El código de empleado es requerido.
          </small>
        </div>
        <div>
          <p-floatLabel>
            <input pInputText id="firstName" formControlName="firstName" class="w-full" />
            <label for="firstName">Nombres</label>
          </p-floatLabel>
          <small *ngIf="employeeForm.get('firstName')?.invalid && employeeForm.get('firstName')?.touched" class="p-error">
            El nombre es requerido.
          </small>
        </div>
        <div>
          <p-floatLabel>
            <input pInputText id="lastName" formControlName="lastName" class="w-full" />
            <label for="lastName">Apellidos</label>
          </p-floatLabel>
          <small *ngIf="employeeForm.get('lastName')?.invalid && employeeForm.get('lastName')?.touched" class="p-error">
            El apellido es requerido.
          </small>
        </div>
        <div class="md:col-span-2">
          <div class="p-inputgroup">
            <p-dropdown id="positionId" [options]="(workPositions$ | async) ?? []" formControlName="positionId"
              optionLabel="name" optionValue="id" placeholder="Seleccione un cargo" [filter]="true" filterBy="name"
              styleClass="w-full"></p-dropdown>
            <button pButton icon="pi pi-plus" type="button" (click)="showNewPositionDialog = true"
              styleClass="p-button-secondary" pTooltip="Crear Nuevo Cargo"></button>
          </div>
          <small *ngIf="employeeForm.get('positionId')?.invalid && employeeForm.get('positionId')?.touched" class="p-error">
            Debe seleccionar un cargo.
          </small>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Sección de Contacto y Biometría -->
      <h3 class="text-lg font-semibold text-gray-700 my-4">Información de Contacto y Biometría</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <p-floatLabel>
            <input pInputText id="email" formControlName="email" type="email" class="w-full" />
            <label for="email">Email (Para notificaciones)</label>
          </p-floatLabel>
          <small *ngIf="employeeForm.get('email')?.invalid && employeeForm.get('email')?.touched" class="p-error">
            <span *ngIf="employeeForm.get('email')?.errors?.['required']">El email es requerido.</span>
            <span *ngIf="employeeForm.get('email')?.errors?.['email']">El formato del email no es válido.</span>
          </small>
        </div>
        <p-floatLabel>
          <input pInputText id="phoneNumber" formControlName="phoneNumber" type="tel" class="w-full" />
          <label for="phoneNumber">Número Telefónico</label>
        </p-floatLabel>
        <div class="md:col-span-2">
          <p-floatLabel>
            <input pInputText id="biometricHash" formControlName="biometricHash" class="w-full" />
            <label for="biometricHash">Hash Biométrico (ID de Dispositivo)</label>
          </p-floatLabel>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Sección de Cuenta Web -->
      <h3 class="text-lg font-semibold text-gray-700 my-4">Configuración de Cuenta Web</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <p-floatLabel>
            <input pInputText id="username" formControlName="username" class="w-full" />
            <label for="username">Usuario Web (Login)</label>
          </p-floatLabel>
          <small *ngIf="employeeForm.get('username')?.invalid && employeeForm.get('username')?.touched" class="p-error">
            El nombre de usuario es requerido.
          </small>
        </div>
        <div>
          <p-floatLabel>
            <p-password id="password" formControlName="password" [toggleMask]="true" [feedback]="true"
              styleClass="w-full" inputStyleClass="w-full"></p-password>
            <label for="password">Contraseña</label>
          </p-floatLabel>
          <small *ngIf="isEditMode" class="text-xs text-gray-500 mt-1">Dejar en blanco para no cambiar la contraseña.</small>
          <small *ngIf="employeeForm.get('password')?.invalid && employeeForm.get('password')?.touched" class="p-error">
            <span *ngIf="employeeForm.get('password')?.errors?.['required']">La contraseña es requerida.</span>
            <span *ngIf="employeeForm.get('password')?.errors?.['minlength']">La contraseña debe tener al menos 6 caracteres.</span>
          </small>
        </div>
        <div class="md:col-span-2">
          <p-dropdown id="roleName" [options]="availableRoles" formControlName="roleName"
            placeholder="Seleccione un rol" styleClass="w-full">
          </p-dropdown>
        </div>
      </div>

      <p-button type="submit" [label]="isEditMode ? (isLoading ? 'Actualizando...' : 'Actualizar Empleado') : (isLoading ? 'Registrando...' : 'Registrar Empleado')"
        [loading]="isLoading" loadingIcon="pi pi-spin pi-spinner" [disabled]="employeeForm.invalid || isLoading"
        styleClass="w-full p-button-success mt-8"></p-button>
    </form>
  </p-panel>
</div>

<!-- Diálogo para Crear Nuevo Cargo -->
<p-dialog header="Crear Nuevo Cargo" [(visible)]="showNewPositionDialog" [modal]="true" [style]="{width: '30rem'}"
  [draggable]="false" [resizable]="false">
  <div class="p-fluid space-y-4 pt-4">
    <p-floatLabel>
      <input pInputText id="positionName" type="text" [(ngModel)]="newPositionName" name="newPositionName"
        class="w-full" required />
      <label for="positionName">Nombre del Cargo</label>
    </p-floatLabel>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" icon="pi pi-times" (click)="showNewPositionDialog = false"
      styleClass="p-button-text p-button-secondary"></p-button>
    <p-button label="Crear Cargo" icon="pi pi-check" (onClick)="createWorkPosition()"
      [disabled]="!newPositionName.trim() || isCreatingPosition" [loading]="isCreatingPosition"
      styleClass="p-button-success"></p-button>
  </ng-template>
</p-dialog>
